<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MAIA Â· PubMed Microproyecto 1</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Mono:ital,wght@0,300;0,400;0,500;1,400&family=Sora:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='20' fill='%236366f1'/%3E%3Ctext x='50' y='62' font-size='52' text-anchor='middle' fill='white' font-family='Arial'%3EM%3C/text%3E%3C/svg%3E">
  <style>
    /* ===== TOKENS ===== */
    :root {
      color-scheme: dark;
      --bg:       #080c18;
      --bg2:      #0c1120;
      --bg3:      #111827;
      --surface:  rgba(255,255,255,.042);
      --surface2: rgba(255,255,255,.07);
      --text:     #e8eeff;
      --muted:    #8899cc;
      --border:   rgba(255,255,255,.09);
      --border2:  rgba(255,255,255,.16);
      --shadow-sm:  0 2px 8px rgba(0,0,0,.4);
      --shadow-md:  0 8px 24px rgba(0,0,0,.45);
      --shadow-lg:  0 16px 48px rgba(0,0,0,.55);
      --accent:   #6fa3ff;
      --accent2:  #a07cff;
      --ok:       #3ddba0;
      --warn:     #ffc84a;
      --err:      #ff5f7e;
      --chip:     #172040;
      --radius:   20px;
      --radius-sm:12px;
      --font-sans:"Sora", system-ui, sans-serif;
      --font-mono:"DM Mono", ui-monospace, monospace;

      /* Category colors (RGB triplets for alpha reuse) */
      --c-bg:   41, 91, 255;
      --c-obj:  16, 185, 129;
      --c-mth:  245, 158, 11;
      --c-res:  168, 85, 247;
      --c-con:  244, 63, 94;
    }
    [data-theme="light"] {
      color-scheme: light;
      --bg:       #eef2ff;
      --bg2:      #e4eaff;
      --bg3:      #ffffff;
      --surface:  #ffffff;
      --surface2: #f4f7ff;
      --text:     #0a1128;
      --muted:    #3d4f7a;
      --border:   rgba(17,24,80,.14);
      --border2:  rgba(17,24,80,.26);
      --shadow-sm:  0 2px 8px rgba(17,24,80,.09);
      --shadow-md:  0 6px 20px rgba(17,24,80,.11);
      --shadow-lg:  0 16px 48px rgba(17,24,80,.18);
      --accent:   #2952e8;
      --accent2:  #7c3aed;
      --ok:       #059669;
      --warn:     #b45309;
      --err:      #dc2626;
      --chip:     #e8eeff;
    }
    /* ===== LIGHT MODE OVERRIDES ===== */

    /* ===== RESET ===== */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { scroll-behavior: smooth; }
    body {
      font-family: var(--font-sans);
      color: var(--text);
      background:
        radial-gradient(ellipse 1400px 600px at 5% -5%,  rgba(var(--c-bg), .18) 0%, transparent 65%),
        radial-gradient(ellipse 1000px 700px at 95% 5%,  rgba(var(--c-res), .14) 0%, transparent 60%),
        radial-gradient(ellipse 900px  500px at 50% 100%, rgba(var(--c-obj), .10) 0%, transparent 60%),
        linear-gradient(170deg, var(--bg) 0%, var(--bg2) 100%);
      min-height: 100vh;
    }

    /* ===== LAYOUT ===== */
    .wrap { max-width: 1200px; margin: 0 auto; padding: 22px 18px 48px; }

    /* ===== TOPBAR ===== */
    .topbar {
      display: flex; align-items: center; justify-content: space-between; gap: 14px; flex-wrap: wrap;
      padding: 12px 16px;
      border: 1px solid var(--border);
      background: var(--surface);
      border-radius: var(--radius);
      box-shadow: var(--shadow-md);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      animation: fadeSlideDown .45s cubic-bezier(.22,1,.36,1) both;
    }
    @keyframes fadeSlideDown {
      from { opacity:0; transform: translateY(-12px); }
      to   { opacity:1; transform: translateY(0); }
    }
    .brand { display: flex; align-items: center; gap: 12px; }
    .logo {
      width: 68px; height: 46px;
      border-radius: 14px;
      background: linear-gradient(135deg, rgba(var(--c-bg),.8), rgba(var(--c-res),.8));
      box-shadow: 0 6px 20px rgba(var(--c-bg),.3);
      overflow: hidden; flex-shrink: 0;
    }
    .logo img { width:100%; height:100%; object-fit:cover; border-radius:14px; }
    .brand-text h1 { font-size: 15px; font-weight: 700; letter-spacing: .1px; line-height:1.1; }
    .brand-text .sub { font-size: 11.5px; color: var(--muted); margin-top: 2px; font-weight: 400; }
    .top-actions { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }

    /* ===== PILLS ===== */
    .pill {
      display: inline-flex; align-items: center; gap: 7px;
      padding: 7px 10px;
      border: 1px solid var(--border);
      border-radius: 999px;
      background: var(--surface);
      font-size: 12px; color: var(--muted); white-space: nowrap;
    }
    .dot { width: 7px; height: 7px; border-radius: 50%; background: var(--warn); transition: background .3s; flex-shrink:0; }
    .dot.ok  { background: var(--ok); box-shadow: 0 0 6px var(--ok); }
    .dot.err { background: var(--err); }
    .dot.connecting { background: var(--warn); animation: pulse .9s ease-in-out infinite; }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.4} }

    /* ===== BUTTONS ===== */
    .btn {
      appearance: none;
      border: 1px solid var(--border2);
      background: var(--surface);
      color: var(--text);
      padding: 9px 14px;
      border-radius: var(--radius-sm);
      font-family: var(--font-sans);
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
      display: inline-flex; align-items: center; gap: 7px;
      transition: background .15s, border-color .15s, transform .08s, box-shadow .15s;
      user-select: none; text-decoration: none;
      white-space: nowrap;
    }
    .btn:hover  { background: var(--surface2); border-color: var(--border2); box-shadow: var(--shadow-sm); }
    .btn:active { transform: translateY(1px); }
    .btn.primary {
      border-color: rgba(var(--c-bg),.55);
      background: linear-gradient(135deg, rgba(var(--c-bg),.22), rgba(var(--c-res),.18));
      color: var(--text);
    }
    .btn.primary:hover { background: linear-gradient(135deg, rgba(var(--c-bg),.30), rgba(var(--c-res),.24)); }
    .btn[disabled] { opacity: .45; cursor: not-allowed; pointer-events: none; }
    .btn.sm { padding: 6px 10px; font-size: 12px; border-radius: 10px; }

    /* ===== CARDS ===== */
    .card {
      border: 1px solid var(--border);
      background: var(--surface);
      border-radius: var(--radius);
      box-shadow: var(--shadow-md);
      overflow: hidden;
      animation: fadeUp .5s cubic-bezier(.22,1,.36,1) both;
    }
    @keyframes fadeUp {
      from { opacity:0; transform: translateY(16px); }
      to   { opacity:1; transform: translateY(0); }
    }
    .card .hd {
      padding: 14px 18px;
      display: flex; align-items: center; justify-content: space-between; gap: 12px;
      background: var(--surface2);
      border-bottom: 1px solid var(--border);
    }
    .card .hd h2 { font-size: 14px; font-weight: 700; letter-spacing: .15px; }
    .card .hd .hint { font-size: 12px; color: var(--muted); margin-top: 2px; font-weight: 400; }
    .card .bd { padding: 18px; }

    /* ===== GRID ===== */
    .main-grid { display: grid; grid-template-columns: 1fr; gap: 18px; margin-top: 18px; align-items: start; }

    /* ===== TEXTAREA & ANNOTATED ===== */
    .input-area { position: relative; }
    textarea {
      width: 100%; min-height: 300px; resize: vertical;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: var(--surface2);
      color: var(--text);
      padding: 14px;
      outline: none;
      font-family: var(--font-sans);
      font-size: 13.5px; line-height: 1.65;
      transition: border-color .2s, box-shadow .2s;
    }
    [data-theme="light"] textarea { background: #ffffff; border-color: var(--border2); }
    textarea:focus { border-color: rgba(var(--c-bg),.6); box-shadow: 0 0 0 3px rgba(var(--c-bg),.14); }

    #annotInput {
      display: none;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: var(--surface2);
      color: var(--text);
      padding: 14px;
      font-size: 13.5px; line-height: 1.65;
      white-space: pre-wrap;
      min-height: 300px;
      cursor: default;
    }
    [data-theme="light"] #annotInput { background: #ffffff; border-color: var(--border2); }

    /* ===== HIGHLIGHTS ===== */
    .hl {
      padding: 2px 4px;
      border-radius: 6px;
      border: 1px solid transparent;
      cursor: pointer;
      transition: filter .12s, transform .08s;
      box-decoration-break: clone;
      -webkit-box-decoration-break: clone;
      position: relative;
    }
    .hl:hover { filter: brightness(1.2); }
    .hl:active { transform: scale(.99); }
    .hl.Background { background: rgba(var(--c-bg), .22); border-color: rgba(var(--c-bg),.35); }
    .hl.Objective  { background: rgba(var(--c-obj), .22); border-color: rgba(var(--c-obj),.35); }
    .hl.Methods    { background: rgba(var(--c-mth), .22); border-color: rgba(var(--c-mth),.35); }
    .hl.Results    { background: rgba(var(--c-res), .22); border-color: rgba(var(--c-res),.35); }
    .hl.Conclusions{ background: rgba(var(--c-con), .18); border-color: rgba(var(--c-con),.32); }
    [data-theme="light"] .hl.Background { background: rgba(var(--c-bg), .14); border-color: rgba(var(--c-bg),.40); }
    [data-theme="light"] .hl.Objective  { background: rgba(var(--c-obj), .14); border-color: rgba(var(--c-obj),.40); }
    [data-theme="light"] .hl.Methods    { background: rgba(var(--c-mth), .16); border-color: rgba(var(--c-mth),.42); }
    [data-theme="light"] .hl.Results    { background: rgba(var(--c-res), .14); border-color: rgba(var(--c-res),.40); }
    [data-theme="light"] .hl.Conclusions{ background: rgba(var(--c-con), .12); border-color: rgba(var(--c-con),.38); }

    /* ===== POPOVER ===== */
    #popover {
      position: fixed;
      z-index: 9999;
      width: 260px;
      background: var(--bg3);
      border: 1px solid var(--border2);
      border-radius: 14px;
      box-shadow: var(--shadow-lg);
      padding: 12px 14px;
      font-size: 12.5px;
      pointer-events: none;
      opacity: 0;
      transform: translateY(4px) scale(.97);
      transition: opacity .15s, transform .15s;
    }
    #popover.visible {
      opacity: 1;
      transform: translateY(0) scale(1);
      pointer-events: auto;
    }
    #popover .pop-label { font-weight: 700; font-size: 13px; margin-bottom: 6px; }
    #popover .pop-row   { display: flex; justify-content: space-between; color: var(--muted); margin-top: 4px; }
    #popover .pop-conf-bar {
      height: 4px; border-radius: 999px;
      background: var(--border); margin-top: 8px; overflow: hidden;
    }
    #popover .pop-conf-fill {
      height: 100%; border-radius: 999px;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      transition: width .3s ease;
    }
    #popover .pop-note { font-size: 11px; color: var(--muted); margin-top: 8px; line-height: 1.4; }

    /* ===== BADGES ===== */
    .badge {
      display: inline-flex; align-items: center; justify-content: center;
      padding: 2px 9px;
      border-radius: 999px;
      background: var(--chip);
      border: 1px solid var(--border);
      color: var(--text);
      font-size: 11.5px; font-weight: 700;
      white-space: nowrap;
    }
    .badge.tag.Background { background: rgba(var(--c-bg),.22); border-color: rgba(var(--c-bg),.45); }
    .badge.tag.Objective  { background: rgba(var(--c-obj),.22); border-color: rgba(var(--c-obj),.45); }
    .badge.tag.Methods    { background: rgba(var(--c-mth),.22); border-color: rgba(var(--c-mth),.45); }
    .badge.tag.Results    { background: rgba(var(--c-res),.22); border-color: rgba(var(--c-res),.45); }
    .badge.tag.Conclusions{ background: rgba(var(--c-con),.18); border-color: rgba(var(--c-con),.42); }

    /* ===== KPIs ===== */
    .kpis { display: grid; grid-template-columns: repeat(5,1fr); gap: 10px; margin-top: 14px; }
    @media (max-width:600px) { .kpis { grid-template-columns: repeat(3,1fr); } }
    @media (max-width:400px) { .kpis { grid-template-columns: repeat(2,1fr); } }
    .kpi {
      border: 1px solid var(--border);
      background: var(--surface);
      border-radius: 14px;
      padding: 12px;
      text-align: center;
      transition: border-color .2s, box-shadow .2s;
    }
    .kpi:hover { border-color: var(--border2); box-shadow: var(--shadow-sm); }
    .kpi .t  { font-size: 11.5px; color: var(--muted); display: flex; align-items: center; justify-content: center; gap: 6px; }
    .kpi .v  { font-size: 22px; font-weight: 800; margin-top: 6px; letter-spacing: -.5px; }

    /* ===== FILTERS ROW ===== */
    .filters-row {
      display: flex; align-items: center; justify-content: space-between;
      gap: 10px; flex-wrap: wrap;
      margin-top: 14px;
    }
    .filters-left  { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    .filters-right { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    select, input[type="search"] {
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text);
      padding: 8px 12px;
      font-family: var(--font-sans);
      font-size: 13px;
      outline: none;
      transition: border-color .15s, box-shadow .15s;
    }
    select:focus, input[type="search"]:focus {
      border-color: rgba(var(--c-bg),.5);
      box-shadow: 0 0 0 3px rgba(var(--c-bg),.12);
    }
    input[type="search"] { flex: 1; min-width: 160px; max-width: 360px; }
    select option { background: var(--bg3); color: var(--text); }

    /* ===== TABLE ===== */
    .table-wrap { overflow-x: auto; margin-top: 14px; border-radius: 14px; border: 1px solid var(--border); }
    table {
      width: 100%; border-collapse: separate; border-spacing: 0;
      background: var(--surface);
    }
    thead th {
      text-align: left; font-size: 11.5px; color: var(--muted);
      padding: 10px 14px;
      border-bottom: 1px solid var(--border);
      background: var(--surface2);
      position: sticky; top: 0;
      backdrop-filter: blur(8px); z-index: 1;
      font-weight: 600; letter-spacing: .3px; text-transform: uppercase;
    }
    tbody td {
      padding: 11px 14px;
      border-bottom: 1px solid var(--border);
      vertical-align: top;
      font-size: 13px; line-height: 1.5;
    }
    tbody tr:hover td  { background: rgba(var(--c-bg),.07); }
    tbody tr:last-child td { border-bottom: none; }
    .mono { font-family: var(--font-mono); }
    .conf-cell { font-family: var(--font-mono); font-size: 12.5px; }

    /* Confidence mini-bar inside table */
    .conf-wrap { display: flex; align-items: center; gap: 6px; }
    .conf-bar  { flex: 1; height: 3px; background: var(--border); border-radius: 99px; overflow: hidden; min-width: 40px; }
    .conf-fill { height: 100%; border-radius: 99px; background: linear-gradient(90deg, var(--accent), var(--accent2)); }

    /* ===== TOAST ===== */
    #msg { margin-top: 12px; }
    .toast {
      padding: 10px 14px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--muted);
      font-size: 13px;
      animation: fadeUp .25s ease both;
    }
    .toast.ok  { border-color: rgba(var(--c-obj),.4); color: var(--text); }
    .toast.err { border-color: rgba(var(--c-con),.4); color: var(--text); }
    .toast b   { font-weight: 700; }
    .toast .small { font-size: 11.5px; color: var(--muted); margin-top: 3px; }

    /* ===== SPINNER ===== */
    .sp { display: none; }
    .sp.show { display: inline-flex; align-items: center; gap: 8px; color: var(--muted); font-size: 13px; }
    .spin {
      width: 14px; height: 14px;
      border-radius: 50%;
      border: 2px solid var(--border2);
      border-top-color: var(--accent);
      animation: rot 1s linear infinite;
    }
    @keyframes rot { to { transform: rotate(360deg); } }

    /* ===== ACTION ROW ===== */
    .action-row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; margin-top: 14px; }

    /* ===== RESULTS FOOTER ===== */
    .results-footer {
      display: none;
      margin-top: 14px;
    }
    .legend-row {
      display: flex; gap: 7px; flex-wrap: wrap; align-items: center; justify-content: flex-end;
    }

    /* ===== SEGMENTS CARD ===== */
    .seg-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    @media (max-width: 640px) { .seg-grid { grid-template-columns: 1fr; } }
    .seg-card {
      border: 1px solid var(--border);
      background: var(--surface);
      border-radius: 14px;
      padding: 14px;
    }
    .seg-card h3 {
      font-size: 13px; font-weight: 700;
      display: flex; align-items: center; justify-content: space-between; gap: 8px;
      margin-bottom: 10px;
    }
    .seg-list { padding-left: 18px; }
    .seg-list li {
      margin: 6px 0; line-height: 1.5; font-size: 12.5px;
    }
    .no-segs { color: var(--muted); font-size: 12.5px; }

    /* ===== CHAR LIMIT WARN ===== */
    #charCount.warn { color: var(--err); font-weight: 700; }

    /* ===== CACHED BANNER ===== */
    .cache-banner {
      display: none;
      padding: 8px 12px;
      border: 1px solid rgba(var(--c-mth),.4);
      background: rgba(var(--c-mth),.08);
      border-radius: 10px;
      font-size: 12px;
      color: var(--muted);
      margin-top: 10px;
    }
    .cache-banner.show { display: flex; align-items: center; gap: 8px; }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 640px) {
      .topbar { flex-direction: column; align-items: flex-start; }
      .top-actions { width: 100%; justify-content: flex-start; }
    }
    @media (max-width: 480px) {
      .btn { padding: 8px 11px; font-size: 12.5px; }
      input[type="search"] { max-width: 100%; }
    }
  </style>
</head>
<body>
  <div class="wrap">

    <!-- TOPBAR -->
    <div class="topbar">
      <div class="brand">
        <div class="logo"><img src="img/maia.jpg" alt="MAIA Â· UNIANDES" /></div>
        <div class="brand-text">
          <h1>PubMed Â· Microproyecto 1</h1>
          <div class="sub">Sequential Sentence Classification in Medical Abstracts</div>
        </div>
      </div>
      <div class="top-actions">
        <div class="pill" title="Estado del backend">
          <span class="dot connecting" id="healthDot"></span>
          <span id="healthText">Conectandoâ€¦</span>
        </div>
        <div class="pill" id="pillModel" title="VersiÃ³n del modelo activo">
          <span>Modelo</span>
          <span class="badge mono" id="modelBadge">â€”</span>
        </div>
        <button class="btn" id="btnTheme" title="Alternar tema claro / oscuro">ðŸŒ“ Tema</button>
      </div>
    </div>

    <!-- MAIN GRID -->
    <div class="main-grid">

      <!-- INPUT CARD -->
      <div class="card" style="animation-delay:.08s">
        <div class="hd">
          <div>
            <h2>Entrada</h2>
            <div class="hint">Pegue un abstract mÃ©dico. Cada oraciÃ³n serÃ¡ segmentada y clasificada automÃ¡ticamente.</div>
          </div>
          <div class="pill" title="Longitud del texto actual">
            Caracteres <span class="mono" id="charCount">0</span>
            <span id="charLimit" style="color:var(--muted);font-size:11px;">/ 8000</span>
          </div>
        </div>
        <div class="bd">
          <div class="input-area">
            <textarea id="inputText" placeholder="Pegue aquÃ­ el texto fuente (mÃ¡x. 8 000 caracteres)â€¦" spellcheck="false"></textarea>
            <div id="annotInput" role="region" aria-label="Texto anotado"></div>
          </div>

          <div class="action-row">
            <button class="btn primary" id="btnPredict">âš¡ Categorizar</button>
            <span class="sp" id="spinner"><span class="spin"></span> Procesandoâ€¦</span>
            <button class="btn" id="btnExample">ðŸ§ª Ejemplo</button>
            <button class="btn" id="btnNewAnalysis" style="display:none;">ðŸ†• Nuevo anÃ¡lisis</button>
          </div>

          <div id="msg"></div>
          <div class="cache-banner" id="cacheBanner">
            <span>ðŸ’¾</span>
            <span>Mostrando Ãºltimo anÃ¡lisis guardado. Presione <strong>Nuevo anÃ¡lisis</strong> para comenzar uno nuevo.</span>
          </div>

          <!-- KPIs -->
          <div class="kpis" id="kpis"></div>

          <!-- FILTERS -->
          <div class="filters-row" id="filtersRow" style="display:none;">
            <div class="filters-left">
              <select id="filterLabel">
                <option value="ALL">Todas las etiquetas</option>
                <option value="Background">Background</option>
                <option value="Objective">Objective</option>
                <option value="Methods">Methods</option>
                <option value="Results">Results</option>
                <option value="Conclusions">Conclusions</option>
              </select>
              <select id="sortMode">
                <option value="index">Secuencia</option>
                <option value="conf_desc">Confianza â†“</option>
                <option value="conf_asc">Confianza â†‘</option>
              </select>
              <input id="search" type="search" placeholder="Buscar en oracionesâ€¦" />
            </div>
            <div class="filters-right">
              <button class="btn sm" id="btnExportJSON" disabled>â¬‡ JSON</button>
              <button class="btn sm" id="btnExportCSV"  disabled>â¬‡ CSV</button>
            </div>
          </div>

          <!-- TABLE -->
          <div id="out"></div>

          <!-- RESULTS FOOTER -->
          <div class="results-footer" id="resultsFooter">
            <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;">
              <div class="pill">Total de oraciones: <span class="mono" id="sentCountFooter">â€”</span></div>
              <div class="legend-row">
                <span class="badge tag Background">Background</span>
                <span class="badge tag Objective">Objective</span>
                <span class="badge tag Methods">Methods</span>
                <span class="badge tag Results">Results</span>
                <span class="badge tag Conclusions">Conclusions</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- SEGMENTS CARD -->
      <div class="card" id="segmentsCard" style="display:none;animation-delay:.14s">
        <div class="hd">
          <div>
            <h2>Segmentos hallados por categorÃ­a</h2>
            <div class="hint">Oraciones agrupadas por etiqueta para facilitar revisiÃ³n y reutilizaciÃ³n.</div>
          </div>
        </div>
        <div class="bd">
          <div class="seg-grid" id="segmentsByLabel"></div>
        </div>
      </div>

    </div><!-- /main-grid -->
  </div><!-- /wrap -->

  <!-- POPOVER -->
  <div id="popover" role="tooltip" aria-live="polite">
    <div class="pop-label" id="popLabel">â€”</div>
    <div class="pop-row">
      <span>OraciÃ³n #<span id="popIndex">â€”</span></span>
      <span>conf <span id="popConf" class="mono">â€”</span></span>
    </div>
    <div class="pop-conf-bar"><div class="pop-conf-fill" id="popConfFill" style="width:0%"></div></div>
    <div class="pop-note" id="popNote">â€”</div>
    <div class="pop-note" style="margin-top:6px; font-style:italic; opacity:.7;">
      âš  Score heurÃ­stico â€” no es probabilidad calibrada
    </div>
  </div>

  <script>
  (() => {
    "use strict";

    // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const $ = id => document.getElementById(id);
    const esc = s => String(s ?? "").replace(/[&<>"']/g, m =>
      ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));

    const CAT_COLORS = {
      Background: "var(--c-bg)",  Objective: "var(--c-obj)",
      Methods:    "var(--c-mth)", Results:   "var(--c-res)",
      Conclusions:"var(--c-con)"
    };
    const CAT_NOTES = {
      Background: "Contexto general o antecedentes del estudio.",
      Objective:  "PropÃ³sito o pregunta de investigaciÃ³n.",
      Methods:    "DiseÃ±o, procedimientos y participantes.",
      Results:    "Hallazgos cuantitativos o cualitativos.",
      Conclusions:"InterpretaciÃ³n, implicaciones y cierre."
    };

    // â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let last   = null;   // Ãºltimo PredictOut
    const MAX_CHARS = 8000;

    // â”€â”€ LocalStorage persistence â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const LS_KEY_DATA  = "maia_mp1_last_result";
    const LS_KEY_TEXT  = "maia_mp1_last_text";
    const LS_KEY_THEME = "maia_mp1_theme";

    function saveState() {
      try {
        if (last) {
          localStorage.setItem(LS_KEY_DATA, JSON.stringify(last));
          localStorage.setItem(LS_KEY_TEXT, $("inputText").value || "");
        }
      } catch (_) {}
    }

    function loadState() {
      try {
        const raw = localStorage.getItem(LS_KEY_DATA);
        const txt = localStorage.getItem(LS_KEY_TEXT) || "";
        if (raw && txt) {
          last = JSON.parse(raw);
          $("inputText").value = txt;
          updateCharCount();
          return true;
        }
      } catch (_) {}
      return false;
    }

    function clearState() {
      try {
        localStorage.removeItem(LS_KEY_DATA);
        localStorage.removeItem(LS_KEY_TEXT);
      } catch (_) {}
    }

    // â”€â”€ Char count â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function updateCharCount() {
      const n = ($("inputText").value || "").length;
      $("charCount").textContent = n;
      $("charCount").className = n > MAX_CHARS ? "mono warn" : "mono";
    }

    // â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function setToast(type, title, detail) {
      const d = document.createElement("div");
      d.className = "toast " + (type || "");
      d.innerHTML = `<div><b>${esc(title)}</b></div>` +
        (detail ? `<div class="small">${esc(detail)}</div>` : "");
      $("msg").innerHTML = "";
      $("msg").appendChild(d);
    }

    // â”€â”€ Export â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function toCSV(rows) {
      const h = ["index","label","confidence","sentence"];
      const q = v => `"${String(v ?? "").replace(/"/g,'""')}"`;
      return [h.join(","), ...rows.map(r =>
        [r.index, r.label, r.confidence, r.sentence].map(q).join(",")
      )].join("\n");
    }
    function downloadFile(name, content, mime) {
      const a = Object.assign(document.createElement("a"), {
        href: URL.createObjectURL(new Blob([content], { type: mime })),
        download: name
      });
      a.click();
      URL.revokeObjectURL(a.href);
    }

    // â”€â”€ Filters â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function applyFilters(sentences) {
      const q  = ($("search").value || "").trim().toLowerCase();
      const fl = $("filterLabel").value;
      const sm = $("sortMode").value;
      let arr = [...sentences];
      if (fl !== "ALL") arr = arr.filter(x => x.label === fl);
      if (q)           arr = arr.filter(x => (x.sentence||"").toLowerCase().includes(q));
      if (sm === "index")     arr.sort((a,b) => a.index - b.index);
      if (sm === "conf_desc") arr.sort((a,b) => b.confidence - a.confidence);
      if (sm === "conf_asc")  arr.sort((a,b) => a.confidence - b.confidence);
      return arr;
    }

    // â”€â”€ KPIs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderKPIs(resp) {
      const c = { Background:0, Objective:0, Methods:0, Results:0, Conclusions:0 };
      for (const s of resp.sentences) c[s.label] = (c[s.label]||0) + 1;
      $("kpis").innerHTML = Object.entries(c).map(([k,v]) => `
        <div class="kpi">
          <div class="t"><span class="badge tag ${k}">${k}</span></div>
          <div class="v">${v}</div>
        </div>`).join("");
    }

    // â”€â”€ Table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderTable(resp) {
      const rows = applyFilters(resp.sentences);
      $("sentCountFooter").textContent = resp.sentences.length;
      const pct = c => Math.round(c * 100);
      const body = rows.map(r => `
        <tr>
          <td class="mono" style="color:var(--muted);font-size:12px;">${r.index}</td>
          <td><span class="badge tag ${r.label}">${r.label}</span></td>
          <td>
            <div class="conf-wrap">
              <span class="conf-cell">${(r.confidence).toFixed(3)}</span>
              <div class="conf-bar"><div class="conf-fill" style="width:${pct(r.confidence)}%"></div></div>
            </div>
          </td>
          <td>${esc(r.sentence ?? "")}</td>
        </tr>`).join("");

      $("out").innerHTML = `
        <div class="table-wrap">
          <table>
            <thead><tr>
              <th style="width:52px">#</th>
              <th style="width:142px">Etiqueta</th>
              <th style="width:130px">Confianza</th>
              <th>OraciÃ³n</th>
            </tr></thead>
            <tbody>${body || `<tr><td colspan="4" style="color:var(--muted);padding:18px;text-align:center;">
              Sin resultados con los filtros actuales.</td></tr>`}</tbody>
          </table>
        </div>`;
    }

    // â”€â”€ Annotated view â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderAnnotated(resp) {
      const original = $("inputText").value || "";
      const arr = [...resp.sentences].sort((a,b) => a.start - b.start);
      let html = "", cursor = 0;
      for (const s of arr) {
        const start = Math.max(0, Math.min(s.start, original.length));
        const end   = Math.max(0, Math.min(s.end,   original.length));
        if (end <= cursor) continue;
        if (start > cursor) html += esc(original.slice(cursor, start));
        const frag = original.slice(start, end);
        const conf = (s.confidence ?? 0).toFixed(3);
        html += `<span class="hl ${s.label}"
          data-idx="${s.index}"
          data-label="${s.label}"
          data-conf="${conf}"
          data-note="${esc(CAT_NOTES[s.label]||"")}"
          role="button" tabindex="0"
          aria-label="${s.label} â€” confianza ${conf}"
        >${esc(frag)}</span>`;
        cursor = end;
      }
      if (cursor < original.length) html += esc(original.slice(cursor));
      $("annotInput").innerHTML = html;
    }

    // â”€â”€ Segments â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderSegments(resp) {
      const labels = ["Background","Objective","Methods","Results","Conclusions"];
      const groups = Object.fromEntries(labels.map(l => [l, []]));
      for (const s of resp.sentences) (groups[s.label]||=[]).push(s);

      $("segmentsByLabel").innerHTML = labels.map(l => {
        const items = groups[l] || [];
        const lis = items.map(x =>
          `<li><span class="mono" style="color:var(--muted)">#${x.index}</span> Â· conf ${(x.confidence).toFixed(3)} â€” ${esc((x.sentence||"").trim())}</li>`
        ).join("");
        return `
          <div class="seg-card">
            <h3>
              <span class="badge tag ${l}">${l}</span>
              <span class="mono" style="color:var(--muted);font-size:13px;">${items.length}</span>
            </h3>
            ${items.length
              ? `<ol class="seg-list">${lis}</ol>`
              : `<div class="no-segs">Sin segmentos.</div>`}
          </div>`;
      }).join("");
    }

    // â”€â”€ Render all (post-predict) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderAll(resp) {
      $("modelBadge").textContent = resp.model_version || $("modelBadge").textContent;
      $("btnExportJSON").disabled = false;
      $("btnExportCSV").disabled  = false;
      $("resultsFooter").style.display = "block";
      renderKPIs(resp);
      $("filtersRow").style.display = "flex";
      renderTable(resp);
      renderAnnotated(resp);
      renderSegments(resp);
      showAnnotatedMode();
      $("segmentsCard").style.display = "block";
    }

    // â”€â”€ Mode switch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function showAnnotatedMode() {
      $("inputText").style.display  = "none";
      $("annotInput").style.display = "block";
      $("btnNewAnalysis").style.display = "inline-flex";
      $("btnExample").disabled = true;
    }
    function showEditMode() {
      $("annotInput").style.display = "none";
      $("inputText").style.display  = "block";
      $("btnNewAnalysis").style.display = "none";
      $("btnExample").disabled = false;
    }

    // â”€â”€ Loading state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function setLoading(on) {
      $("spinner").className   = on ? "sp show" : "sp";
      $("btnPredict").disabled = on;
    }

    // â”€â”€ Popover â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const popover = $("popover");
    let popTimeout = null;

    function showPopover(el, x, y) {
      const label = el.dataset.label;
      const conf  = parseFloat(el.dataset.conf);
      $("popLabel").textContent = label;
      $("popLabel").style.color = `rgb(${CAT_COLORS[label] || "var(--text)"})`;
      $("popIndex").textContent = el.dataset.idx;
      $("popConf").textContent  = conf.toFixed(3);
      $("popConfFill").style.width = Math.round(conf * 100) + "%";
      $("popNote").textContent  = el.dataset.note || "";

      // Position
      const pad = 12, w = 260, ww = window.innerWidth, wh = window.innerHeight;
      let px = x + 14, py = y - 10;
      if (px + w + pad > ww) px = x - w - 14;
      if (py + 140 > wh)     py = y - 140;
      popover.style.left = px + "px";
      popover.style.top  = py + "px";
      popover.classList.add("visible");
    }

    function hidePopover() {
      popover.classList.remove("visible");
    }

    document.addEventListener("mouseover", e => {
      const hl = e.target.closest(".hl");
      if (hl) { clearTimeout(popTimeout); showPopover(hl, e.clientX, e.clientY); }
    });
    document.addEventListener("mousemove", e => {
      if (popover.classList.contains("visible")) {
        const hl = e.target.closest(".hl");
        if (hl) showPopover(hl, e.clientX, e.clientY);
        else    hidePopover();
      }
    });
    document.addEventListener("mouseout",  e => {
      if (!e.target.closest(".hl")) hidePopover();
    });
    // Keyboard nav for accessibility
    document.addEventListener("focusin", e => {
      const hl = e.target.closest(".hl");
      if (hl) {
        const r = hl.getBoundingClientRect();
        showPopover(hl, r.left, r.top);
      }
    });
    document.addEventListener("focusout", () => hidePopover());

    // â”€â”€ Health check (smart backoff) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let _healthInterval = null;
    let _healthOk = false;

    async function refreshHealth() {
      try {
        const res = await fetch("/health", { method:"GET", signal: AbortSignal.timeout(4000) });
        if (!res.ok) throw new Error();
        const data = await res.json();
        $("healthDot").className = "dot ok";
        $("healthText").textContent = "Backend OK";
        $("modelBadge").textContent = data.model_version || "â€”";
        if (!_healthOk) {
          _healthOk = true;
          // After first success, poll every 45s
          clearInterval(_healthInterval);
          _healthInterval = setInterval(refreshHealth, 45_000);
        }
      } catch {
        $("healthDot").className = "dot err";
        $("healthText").textContent = "Sin conexiÃ³n";
        if (_healthOk) {
          _healthOk = false;
          // Lost connection â†’ retry every 8s
          clearInterval(_healthInterval);
          _healthInterval = setInterval(refreshHealth, 8_000);
        }
      }
    }

    // â”€â”€ Predict â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function predict() {
      const text = ($("inputText").value || "").trim();
      if (!text) { setToast("err", "Campo vacÃ­o", "Pegue o escriba un abstract antes de clasificar."); return; }
      if (text.length > MAX_CHARS) {
        setToast("err", "Texto demasiado largo", `El lÃ­mite es ${MAX_CHARS} caracteres. Actual: ${text.length}.`);
        return;
      }

      // Reset UI
      $("out").innerHTML = "";
      $("kpis").innerHTML = "";
      $("filtersRow").style.display = "none";
      $("segmentsCard").style.display = "none";
      $("resultsFooter").style.display = "none";
      $("sentCountFooter").textContent = "â€”";
      $("cacheBanner").classList.remove("show");
      setToast("", "Procesandoâ€¦", "Enviando texto a /api/predict");
      setLoading(true);

      try {
        const res = await fetch("/api/predict", {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify({ text }),
          signal: AbortSignal.timeout(30_000),
        });
        if (!res.ok) {
          const t = await res.text();
          throw new Error(`Error del servidor (${res.status}): ${t}`);
        }
        last = await res.json();
        saveState();
        renderAll(last);
        setToast("ok", "Listo", `Se clasificaron ${last.sentences.length} oraciÃ³n${last.sentences.length !== 1 ? "es" : ""}.`);
      } catch (e) {
        setToast("err", "No se pudo clasificar", e.message || "Error desconocido");
      } finally {
        setLoading(false);
      }
    }

    // â”€â”€ Example â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function loadExample() {
      showEditMode();
      const ex = "Cardiovascular diseases remain a leading cause of mortality worldwide, and hypertension is one of the most important modifiable risk factors. Despite the availability of effective therapies, realâ€‘world control rates remain suboptimal in many settings. This study aims to evaluate whether a brief, appâ€‘supported coaching intervention improves blood pressure control in adults with uncontrolled hypertension. We conducted a randomized controlled trial enrolling 240 participants from two outpatient clinics, assigning them 1:1 to the intervention or usual care. Systolic and diastolic blood pressure were measured at baseline and at 12 weeks using standardized automated devices, and adherence was assessed via pharmacy refill data. We found a significant reduction in mean systolic blood pressure in the intervention group compared with controls (âˆ’8.6 mmHg vs âˆ’2.1 mmHg), and medication adherence improved. The intervention increased the proportion of participants achieving guidelineâ€‘recommended targets and improved patientâ€‘reported selfâ€‘efficacy scores. These findings suggest that scalable, lowâ€‘intensity digital coaching can improve shortâ€‘term cardiovascular risk profiles and should be tested in longer followâ€‘up studies.";
      $("inputText").value = ex;
      updateCharCount();
      setToast("", "Ejemplo cargado", "Presione Â«CategorizarÂ» para ver el flujo completo.");
    }

    // â”€â”€ Theme â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function applyTheme(t) {
      document.documentElement.setAttribute("data-theme", t);
      try { localStorage.setItem(LS_KEY_THEME, t); } catch (_) {}
    }
    function toggleTheme() {
      const cur = document.documentElement.getAttribute("data-theme") || "dark";
      applyTheme(cur === "dark" ? "light" : "dark");
    }

    // â”€â”€ New analysis â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function newAnalysis() {
      clearState();
      last = null;
      showEditMode();
      $("out").innerHTML = "";
      $("kpis").innerHTML = "";
      $("filtersRow").style.display = "none";
      $("segmentsCard").style.display = "none";
      $("resultsFooter").style.display = "none";
      $("sentCountFooter").textContent = "â€”";
      $("btnExportJSON").disabled = true;
      $("btnExportCSV").disabled  = true;
      $("cacheBanner").classList.remove("show");
      $("msg").innerHTML = "";
      setToast("", "Nuevo anÃ¡lisis", "Edite o pegue un nuevo abstract y presione Â«CategorizarÂ».");
      $("inputText").focus();
    }

    // â”€â”€ Event listeners â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    $("btnPredict").addEventListener("click", predict);
    $("btnExample").addEventListener("click", loadExample);
    $("btnNewAnalysis").addEventListener("click", newAnalysis);
    $("btnTheme").addEventListener("click", toggleTheme);
    $("inputText").addEventListener("input", updateCharCount);

    $("btnExportJSON").addEventListener("click", () => {
      if (!last) return;
      downloadFile("prediccion_rhetoric.json", JSON.stringify(last, null, 2), "application/json");
    });
    $("btnExportCSV").addEventListener("click", () => {
      if (!last) return;
      downloadFile("prediccion_rhetoric.csv", toCSV(last.sentences), "text/csv");
    });

    ["filterLabel","sortMode","search"].forEach(id => {
      $(id).addEventListener("input",  () => { if (last) renderTable(last); });
      $(id).addEventListener("change", () => { if (last) renderTable(last); });
    });

    // â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    (function init() {
      // Theme
      let theme = "dark";
      try { theme = localStorage.getItem(LS_KEY_THEME) || "dark"; } catch (_) {}
      applyTheme(theme);

      updateCharCount();
      showEditMode();
      $("resultsFooter").style.display = "none";

      // Health check: first call immediately, then smart polling
      refreshHealth();
      _healthInterval = setInterval(refreshHealth, 8_000); // until first success

      // Restore last session if available
      if (loadState() && last) {
        renderAll(last);
        setToast("ok", "SesiÃ³n restaurada", `Ãšltimo anÃ¡lisis: ${last.sentences.length} oraciones clasificadas.`);
        $("cacheBanner").classList.add("show");
      }
    })();

  })();
  </script>
</body>
</html>