<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MAIA ¬∑ PubMed Microproyecto 1</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='20' fill='%236366f1'/%3E%3Ctext x='50' y='62' font-size='52' text-anchor='middle' fill='white' font-family='Arial'%3EM%3C/text%3E%3C/svg%3E">
  <style>
    :root{
      
      color-scheme: dark;
--bg:#0b0f19; --bg2:#0d1326;
      --text:#e7ecff; --muted:#a9b4da;
      --border:rgba(255,255,255,.10);
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --accent:#7aa2ff; --accent2:#9d7bff;
      --ok:#46d39a; --warn:#ffd36a; --err:#ff6b8b;
      --chip:#1a2550;
      --mono:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      --sans:system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans","Helvetica Neue",sans-serif;
      --radius:18px;
    }
    [data-theme="light"]{
      
      color-scheme: light;
--bg:#f7f9ff; --bg2:#eef3ff;
      --text:#111827; --muted:#4b5563;
      --border:rgba(17,24,39,.10);
      --shadow:0 10px 30px rgba(17,24,39,.12);
      --accent:#295bff; --accent2:#6a35ff;
      --ok:#16a34a; --warn:#d97706; --err:#e11d48;
      --chip:#eef3ff;
    }
    *{box-sizing:border-box;}
    body{
      margin:0; font-family:var(--sans); color:var(--text);
      background:
        radial-gradient(1200px 500px at 10% 0%, rgba(122,162,255,.20), transparent 60%),
        radial-gradient(900px 500px at 90% 10%, rgba(157,123,255,.18), transparent 60%),
        linear-gradient(180deg, var(--bg), var(--bg2));
    }
    .wrap{max-width:1180px;margin:0 auto;padding:26px 18px 34px;}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:16px;
      padding:14px 16px;border:1px solid var(--border);
      background:rgba(255,255,255,.04);border-radius:var(--radius);
      box-shadow:var(--shadow);backdrop-filter:blur(10px);
    }
    .brand{display:flex;align-items:center;gap:12px;min-width:240px;}
    .logo {
      width: 68x;
      height: 45px;
      border-radius: 14px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      box-shadow: 0 10px 20px rgba(122,162,255,.25);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .logo img {
      width: 100%;
      height: 100%;
      border-radius: 14px; /* para que siga la forma */
      object-fit: cover;   /* recorta bien la imagen */
    }

    .brand h1{font-size:16px;margin:0;line-height:1.1;letter-spacing:.2px;}
    .brand .sub{font-size:12.5px;color:var(--muted);margin-top:2px;}
    .top-actions{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end;}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border:1px solid var(--border);
      border-radius:999px;background:rgba(255,255,255,.04);
      font-size:12.5px;color:var(--muted);white-space:nowrap;
    }
    .dot{width:8px;height:8px;border-radius:99px;background:var(--warn);}
    .dot.ok{background:var(--ok);} .dot.err{background:var(--err);}
    .btn{
      appearance:none;border:1px solid var(--border);
      background:rgba(255,255,255,.05);color:var(--text);
      padding:10px 12px;border-radius:14px;font-weight:650;
      font-size:13.5px;cursor:pointer;display:inline-flex;
      align-items:center;gap:8px;transition:transform .05s ease,background .15s ease,border-color .15s ease;
      user-select:none;text-decoration:none;
    }
    .btn:hover{background:rgba(255,255,255,.08);} .btn:active{transform:translateY(1px);}
    .btn.primary{border-color:rgba(122,162,255,.45);background:linear-gradient(135deg,rgba(122,162,255,.25),rgba(157,123,255,.18));}
    .btn.danger{border-color:rgba(255,107,139,.35);} .btn[disabled]{opacity:.55;cursor:not-allowed;}
    .grid{display:grid;grid-template-columns: 1fr;gap:18px;margin-top:18px;
  align-items: start;
}
    @media (max-width:980px){.grid{grid-template-columns: 1fr;}.brand{min-width:unset;}}
    .card{
      border:1px solid var(--border);background:rgba(255,255,255,.04);
      border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;
    }
    .card .hd{
      padding:14px 16px;display:flex;align-items:center;justify-content:space-between;gap:12px;
      background:rgba(255,255,255,.03);border-bottom:1px solid var(--border);
    }
    .card .hd h2{margin:0;font-size:14.5px;letter-spacing:.2px;}
    .card .hd .hint{color:var(--muted);font-size:12.5px;}
    .card .bd{padding:16px;}
    textarea{
      width:100%;min-height: 340px;resize:vertical;border-radius:16px;
      border:1px solid var(--border);background:rgba(0,0,0,.12);
      color:var(--text);padding:12px 12px;outline:none;
      font-size:13.5px;line-height:1.5;
    }
    [data-theme="light"] textarea{background:rgba(17,24,39,.02);}
    textarea:focus{border-color:rgba(122,162,255,.6);box-shadow:0 0 0 3px rgba(122,162,255,.18);}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:12px;}
    .meta{display:flex;gap:10px;flex-wrap:wrap;align-items:center;color:var(--muted);font-size:12.5px;}
    .mono{font-family:var(--mono);}
    .kpis{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-top:12px;}
    @media (max-width:980px){.kpis{grid-template-columns:repeat(2,1fr);}}
    .kpi{border:1px solid var(--border);background:rgba(255,255,255,.03);border-radius:16px;padding:12px 12px;place-items: center;}
    .kpi .t{font-size:12px;color:var(--muted);display:flex;align-items:center;gap:8px;place-items: center;}
    .kpi .v{font-size:18px;font-weight:800;margin-top:6px;letter-spacing:.2px;}
    .badge{display:inline-flex;align-items:center;justify-content:center;padding:2px 8px;border-radius:999px;background:var(--chip);border:1px solid var(--border);color:var(--text);font-size:12px;font-weight:700;white-space:nowrap;}
    .filters{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:12px;}
    select,input[type="search"]{border-radius:14px;border:1px solid var(--border);background:rgba(252,252,252,.04);color:var(--text);padding:10px 12px;font-size:13.5px;outline:none;}
    input[type="search"]{width:570px;}
    table{width:100%;border-collapse:separate;border-spacing:0;margin-top:12px;overflow:hidden;border-radius:16px;border:1px solid var(--border);background:rgba(255,255,255,.03);}
    thead th{ text-align:left;font-size:12px;color:var(--muted);padding:10px 12px;border-bottom:1px solid var(--border);background:rgba(255,255,255,.03);position:sticky;top:0;backdrop-filter:blur(8px);z-index:1;}
    tbody td{padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.06);vertical-align:top;font-size:13.5px;line-height:1.45;}
    tbody tr:hover td{background:rgba(122,162,255,.08);} tbody tr:last-child td{border-bottom:none;}
    .toast{margin-top:10px;padding:10px 12px;border-radius:14px;border:1px solid var(--border);background:rgba(255,255,255,.04);color:var(--muted);font-size:13px;}
    .toast.ok{border-color:rgba(70,211,154,.35);color:var(--text);} .toast.err{border-color:rgba(255,107,139,.35);color:var(--text);}
    .toast .small{color:var(--muted);font-size:12px;margin-top:3px;}
.hitem{border:1px solid var(--border);background:rgba(255,255,255,.03);border-radius:16px;padding:10px 12px;cursor:pointer;transition:background .15s ease,border-color .15s ease;}
    .hitem:hover{background:rgba(255,255,255,.05);border-color:rgba(122,162,255,.35);}
    .hitem .ts{font-size:12px;color:var(--muted);} .hitem .tx{margin-top:6px;font-size:13px;line-height:1.35;}
    .right-muted{color:var(--muted);font-size:12.5px;}
    .sp{display:none;} .sp.show{display:inline-flex;align-items:center;gap:8px;}
    .spin{width:14px;height:14px;border-radius:999px;border:2px solid rgba(255,255,255,.25);border-top-color:var(--accent);animation:r 1s linear infinite;}
    @keyframes r{to{transform:rotate(360deg);}}
  
    
    /* Badges por categor√≠a (mismo color que el texto resaltado) */
    .badge.tag{
      border: 1px solid var(--border);
    }
    .badge.tag.Background{ background: rgba(41, 91, 255, .22); border-color: rgba(41, 91, 255, .45); }
    .badge.tag.Objective{ background: rgba(16, 185, 129, .22); border-color: rgba(16, 185, 129, .45); }
    .badge.tag.Methods{ background: rgba(245, 158, 11, .22); border-color: rgba(245, 158, 11, .45); }
    .badge.tag.Results{ background: rgba(168, 85, 247, .22); border-color: rgba(168, 85, 247, .45); }
    .badge.tag.Conclusions{ background: rgba(244, 63, 94, .18); border-color: rgba(244, 63, 94, .42); }


    /* Resaltes por categor√≠a (texto anotado) */
    .hl{
      padding: 2px 4px;
      border-radius: 8px;
      border: 1px solid var(--border);
      box-decoration-break: clone;
      -webkit-box-decoration-break: clone;
    }
    .hl.Background{ background: rgba(41, 91, 255, .22); }
    .hl.Objective{ background: rgba(16, 185, 129, .22); }
    .hl.Methods{ background: rgba(245, 158, 11, .22); }
    .hl.Results{ background: rgba(168, 85, 247, .22); }
    .hl.Conclusions{ background: rgba(244, 63, 94, .18); }

    .segCard{
      border: 1px solid var(--border);
      background: rgba(255,255,255,.03);
      border-radius: 16px;
      padding: 12px 12px;
    }
    .segCard h3{
      margin:0 0 8px 0;
      font-size: 13px;
      letter-spacing: .2px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .segList{ margin:0; padding-left: 18px; }
    .segList li{ margin: 6px 0; line-height: 1.45; }

  
    /* Mejor contraste en listas desplegables (fallback si el navegador ignora color-scheme) */
    select option{
      background: var(--bg);
      color: var(--text);
    }
    [data-theme="light"] select option{
      background: #ffffff;
      color: #111827;
    }

  
    /* √Årea de entrada/anotaci√≥n unificada */
    #annotInput{ resize: vertical; }
    [data-theme="light"] #annotInput{ background: rgba(17,24,39,.02); }

  
    @media (max-width: 900px){
      .grid{ grid-template-columns: 1fr; }
    }
  
    /* Panel auxiliar (eliminado) */
@media (max-width: 900px){
}

  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo"><img  src="img/maia.jpg" alt="UNIANDES - MAIA"/></div>
        <div>
          <h1>PubMed ¬∑ Microproyecto 1</h1>
          <div class="sub">Sequential Sentence Classification in Medical Abstracts</div>
        </div>
      </div>
      <div class="top-actions">
        <div class="pill" title="Estado del backend">
          <span class="dot" id="healthDot"></span>
          <span id="healthText">Conectando‚Ä¶</span>
        </div>
        <div class="pill">
          <span>Modelo</span>
          <span class="badge mono" id="modelBadge">‚Äî</span>
        </div>
        <button class="btn" id="btnTheme" title="Alternar tema">üåì Tema</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="hd">
          <div>
            <h2>Entrada</h2>
            <div class="hint">An√°lisis de medical abstract. Se segmenta y se etiqueta cada oraci√≥n identificada.</div>
          </div>
          <div class="meta">
            <span class="pill">Caracteres <span class="mono" id="charCount">0</span></span>
          </div>
        </div>
        <div class="bd">
          
          <div id="inputArea" style="position:relative;">
            <textarea id="inputText" placeholder="Pegue aqu√≠ el texto fuente..."></textarea>
            <div id="annotInput" style="display:none;border-radius:16px;border:1px solid var(--border);background:rgba(0,0,0,.12);color:var(--text);padding:12px 12px;outline:none;font-size:13.5px;line-height:1.5;white-space:pre-wrap;min-height:340px;"></div>
          </div>


          <div class="row">
            <button class="btn primary" id="btnPredict">‚ö° Categorizar</button>
            <span class="sp" id="spinner"><span class="spin"></span> Procesando‚Ä¶</span>
            <button class="btn" id="btnExample">üß™ Ejemplo</button>
            <button class="btn" id="btnNewAnalysis" style="display:none;">üÜï Nuevo an√°lisis</button>
          </div>

          <div id="msg"></div>
          <div class="kpis" id="kpis"></div>
          
          
          <div class="filters" id="filters" style="display:none;">
            <div class="row" style="display:flex; justify-content:space-between; align-items:center; margin-top:0;">
              <!-- Lado izquierdo -->
              <div class="left-controls" style="display:flex; gap:10px;">
                <select id="filterLabel">
                  <option value="ALL">Todas las etiquetas</option>
                  <option value="Background">Background</option>
                  <option value="Objective">Objective</option>
                  <option value="Methods">Methods</option>
                  <option value="Results">Results</option>
                  <option value="Conclusions">Conclusions</option>
                </select>
                <select id="sortMode">
                  <option value="index">Orden: secuencia</option>
                  <option value="conf_desc">Orden: confianza (‚Üì)</option>
                  <option value="conf_asc">Orden: confianza (‚Üë)</option>
                </select>
                <input id="search" type="search" placeholder="Buscar en oraciones..." />
              </div>

              <!-- Lado derecho -->
              <div class="right-controls" style="display:flex; gap:10px;">
                <button class="btn" id="btnExportJSON" disabled>‚¨áÔ∏è JSON</button>
                <button class="btn" id="btnExportCSV" disabled>‚¨áÔ∏è CSV</button>
              </div>
            </div>
          </div>


          <div id="out"></div>
          <div id="resultsFooter" style="display:none;margin-top:14px;">
            <div class="row" style="justify-content:space-between; align-items:center;">
              <div class="meta">
                <span class="pill">Total de oraciones: <span class="mono" id="sentCountFooter">‚Äî</span></span>                
              </div>
              <div id="annotatedText" style="white-space:pre-wrap; line-height:1.6; font-size:14px;"></div>
                <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
                  <span class="badge tag Background">Background</span>
                  <span class="badge tag Objective">Objective</span>
                  <span class="badge tag Methods">Methods</span>
                  <span class="badge tag Results">Results</span>
                  <span class="badge tag Conclusions">Conclusions</span>
                </div>
            </div>
          </div>
          
        </div>
        


      </div>
      <div class="card" id="segmentsCard" style="display:none;">
        <div class="hd"><div><h2>Segmentos hallados por categor√≠a</h2><div class="hint">Oraciones agrupadas por etiqueta para facilitar revisi√≥n y reutilizaci√≥n.</div></div></div>
          <div id="segmentsWrap" style="margin-top:14px;">
              <div class="bd">
                <div id="segmentsByLabel" class="kpis" style="grid-template-columns: repeat(2, 1fr);"></div>
              </div>
          </div>
      </div>
    </div>




  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    let last = null;

    function esc(s){ 
      s = String(s ?? "");
      return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    function setToast(type, title, detail){
      const box = document.createElement("div");
      box.className = "toast " + (type || "");
      box.innerHTML = `<div><b>${esc(title)}</b></div>` + (detail ? `<div class="small">${esc(detail)}</div>` : "");
      $("msg").innerHTML = "";
      $("msg").appendChild(box);
    }

    function updateCharCount(){ $("charCount").textContent = String(($("inputText").value || "").length); }

    function toCSV(rows){
      const header = ["index","label","confidence","sentence"];
      const escCSV = (v) => `"${String(v ?? "").replace(/"/g,'""')}"`;
      const lines = [header.join(",")];
      for(const r of rows){
        lines.push([r.index, r.label, r.confidence, r.sentence].map(escCSV).join(","));
      }
      return lines.join("\n");
    }

    function downloadFile(name, content, type){
      const blob = new Blob([content], {type});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = name; a.click();
      URL.revokeObjectURL(url);
    }

    function computeCounts(resp){
      const counts = {Background:0,Objective:0,Methods:0,Results:0,Conclusions:0};
      for(const s of resp.sentences) counts[s.label] = (counts[s.label]||0) + 1;
      return counts;
    }

    function renderKPIs(resp){
      const c = computeCounts(resp);
      const items = [
        ["Background", c.Background],
        ["Objective", c.Objective],
        ["Methods", c.Methods],
        ["Results", c.Results],
        ["Conclusions", c.Conclusions],
      ];
      $("kpis").innerHTML = items.map(([k,v]) => `
        <div class="kpi">
          <div class="t"><span class="badge tag ${k}">${k}</span></div>
          <div class="v">${v}</div>
        </div>
      `).join("");
    }

    function applyFilters(sentences){
      const q = ($("search").value || "").trim().toLowerCase();
      const fl = $("filterLabel").value;
      let arr = [...sentences];
      if(fl !== "ALL") arr = arr.filter(x => x.label === fl);
      if(q) arr = arr.filter(x => (x.sentence || "").toLowerCase().includes(q));
      const mode = $("sortMode").value;
      if(mode === "index") arr.sort((a,b)=>a.index-b.index);
      if(mode === "conf_desc") arr.sort((a,b)=>(b.confidence??0)-(a.confidence??0));
      if(mode === "conf_asc") arr.sort((a,b)=>(a.confidence??0)-(b.confidence??0));
      return arr;
    }

    function showAnnotatedMode(){
      $("inputText").style.display = "none";
      $("annotInput").style.display = "block";
      $("btnNewAnalysis").style.display = "inline-flex";
    }

    function showEditMode(){
      $("annotInput").style.display = "none";
      $("inputText").style.display = "block";
      $("btnNewAnalysis").style.display = "none";
    }

    function renderAnnotated(resp){
      const original = $("inputText").value || "";
      let html = "";
      let cursor = 0;
      const arr = [...resp.sentences].sort((a,b)=>a.start-b.start);

      for(const s of arr){
        const start = Math.max(0, Math.min(s.start, original.length));
        const end = Math.max(0, Math.min(s.end, original.length));
        if(end <= cursor) continue;

        if(start > cursor){
          html += esc(original.slice(cursor, start));
        }
        const frag = original.slice(start, end);
        html += `<span class="hl ${s.label}" title="${s.label} ¬∑ conf ${(s.confidence ?? 0).toFixed(3)}">${esc(frag)}</span>`;
        cursor = end;
      }
      if(cursor < original.length){
        html += esc(original.slice(cursor));
      }

      $("annotInput").innerHTML = html;
      showAnnotatedMode();
    }

    function renderSegments(resp){
      const labels = ["Background","Objective","Methods","Results","Conclusions"];
      const groups = {};
      for(const l of labels) groups[l] = [];
      for(const s of resp.sentences){
        (groups[s.label] ||= []).push(s);
      }

      $("segmentsByLabel").innerHTML = labels.map(l => {
        const items = groups[l] || [];
        const lis = items.map(x =>
          `<li><span class="mono">#${x.index}</span> ¬∑ conf ${(x.confidence ?? 0).toFixed(3)} ‚Äî ${esc((x.sentence || "").trim())}</li>`
        ).join("");
        return `
          <div class="segCard">
            <h3><span class="badge tag ${l}">${l}</span><span class="mono">${items.length}</span></h3>
            ${items.length ? `<ol class="segList">${lis}</ol>` : `<div class="right-muted">Sin segmentos.</div>`}
          </div>
        `;
      }).join("");

      $("filters").style.display = "flex";
      $("segmentsCard").style.display = "block";
    }

    function renderTable(resp){
      const rows = applyFilters(resp.sentences);
      $("sentCountFooter").textContent = String(resp.sentences.length);

      const body = rows.map(r => `
        <tr>
          <td class="mono">${r.index}</td>
          <td><span class="badge tag ${r.label}">${r.label}</span></td>
          <td class="mono">${(r.confidence ?? 0).toFixed(3)}</td>
          <td>${esc(r.sentence ?? "")}</td>
        </tr>
      `).join("");

      $("out").innerHTML = `
        <table>
          <thead><tr>
            <th style="width:64px">#</th>
            <th style="width:140px">Etiqueta</th>
            <th style="width:110px">Conf.</th>
            <th>Oraci√≥n</th>
          </tr></thead>
          <tbody>${body || `<tr><td colspan="4" style="color:var(--muted);padding:16px;">Sin resultados con los filtros actuales.</td></tr>`}</tbody>
        </table>
      `;

      // Adicional: texto original resaltado + agrupaci√≥n por categor√≠a
      renderAnnotated(resp);
      renderSegments(resp);
    }

    function setLoading(on){
      $("spinner").className = on ? "sp show" : "sp";
      $("btnPredict").disabled = on;

    }

    async function refreshHealth(){
      try{
        const res = await fetch("/health", {method:"GET"});
        if(!res.ok) throw new Error("Health no disponible");
        const data = await res.json();
        $("healthDot").className = "dot ok";
        $("healthText").textContent = "Backend OK";
        $("modelBadge").textContent = data.model_version || "‚Äî";
      }catch(_){
        $("healthDot").className = "dot err";
        $("healthText").textContent = "Sin conexi√≥n";
        $("modelBadge").textContent = "‚Äî";
      }
    }

    async function predict(){
      $("out").innerHTML = ""; 
      $("kpis").innerHTML = ""; 
      $("filters").style.display="none"; 
      $("segmentsCard").style.display="none"; 
      $("resultsFooter").style.display="none"; 
      $("sentCountFooter").textContent="‚Äî";
      $("filters").style.display = "none"; 
      $("btnExample").disabled = true;
      setToast("", "Procesando‚Ä¶", "Enviando texto a /api/predict");
      setLoading(true);
      
      try{
        const text = ($("inputText").value || "").trim();
        if(!text) throw new Error("El campo de texto est√° vac√≠o.");
        const res = await fetch("/api/predict", {
          method:"POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({text})
        });
        if(!res.ok){
          const t = await res.text();
          throw new Error(`Error del servidor (${res.status}): ${t}`);
        }
        last = await res.json();
        $("modelBadge").textContent = last.model_version || $("modelBadge").textContent;
        $("btnExportJSON").disabled = false;
        $("btnExportCSV").disabled = false;
        $("resultsFooter").style.display = "block";
        renderKPIs(last);
        $("filters").style.display = "flex";
        renderTable(last);
        setToast("ok", "Listo", `Se clasificaron ${last.sentences.length} oraciones, as√≠:`);
        $("btnExample").disabled = true;
      } catch(e){
        setToast("err", "No se pudo clasificar", e.message || "Error desconocido");
        $("btnExample").disabled = false;
      } finally {
        setLoading(false);
        
      }
    }

    function loadExample(){
      showEditMode();
      //const ex = 'Cardiovascular diseases remain a leading cause of mortality worldwide, and hypertension is one of the most important modifiable risk factors. Despite the availability of effective therapies, real‚Äëworld control rates remain suboptimal in many settings. Objective: This study aims to evaluate whether a brief, app‚Äësupported coaching intervention improves blood pressure control in adults with uncontrolled hypertension. Methods: We conducted a randomized controlled trial enrolling 240 participants from two outpatient clinics, assigning them 1:1 to the intervention or usual care. Methods: Systolic and diastolic blood pressure were measured at baseline and at 12 weeks using standardized automated devices, and adherence was assessed via pharmacy refill data. Results: We found a significant reduction in mean systolic blood pressure in the intervention group compared with controls (‚àí8.6 mmHg vs ‚àí2.1 mmHg), and medication adherence improved. Results: The intervention increased the proportion of participants achieving guideline‚Äërecommended targets and improved patient‚Äëreported self‚Äëefficacy scores. Conclusions: These findings suggest that scalable, low‚Äëintensity digital coaching can improve short‚Äëterm cardiovascular risk profiles and should be tested in longer follow‚Äëup studies.';
      const ex = 'Cardiovascular diseases remain a leading cause of mortality worldwide, and hypertension is one of the most important modifiable risk factors. Despite the availability of effective therapies, real‚Äëworld control rates remain suboptimal in many settings. This study aims to evaluate whether a brief, app‚Äësupported coaching intervention improves blood pressure control in adults with uncontrolled hypertension. We conducted a randomized controlled trial enrolling 240 participants from two outpatient clinics, assigning them 1:1 to the intervention or usual care. Systolic and diastolic blood pressure were measured at baseline and at 12 weeks using standardized automated devices, and adherence was assessed via pharmacy refill data. We found a significant reduction in mean systolic blood pressure in the intervention group compared with controls (‚àí8.6 mmHg vs ‚àí2.1 mmHg), and medication adherence improved. The intervention increased the proportion of participants achieving guideline‚Äërecommended targets and improved patient‚Äëreported self‚Äëefficacy scores. These findings suggest that scalable, low‚Äëintensity digital coaching can improve short‚Äëterm cardiovascular risk profiles and should be tested in longer follow‚Äëup studies.';
      $("inputText").value = ex;
      updateCharCount();
      setToast("", "Ejemplo cargado", "Presione ‚ÄúCategorizar‚Äù para ver el flujo completo.");
    }

    function applyTheme(theme){
      document.documentElement.setAttribute("data-theme", theme);
      localStorage.setItem("maia_pubmed_microproyecto1_theme", theme);
    }
    function toggleTheme(){
      const cur = document.documentElement.getAttribute("data-theme") || "dark";
      applyTheme(cur === "dark" ? "light" : "dark");
    }

    $("btnPredict").addEventListener("click", predict);
    $("btnExample").addEventListener("click", loadExample);
    $("btnExportJSON").addEventListener("click", () => {
      if(!last) return;
      downloadFile("prediccion_rhetoric.json", JSON.stringify(last, null, 2), "application/json");
    });
    $("btnExportCSV").addEventListener("click", () => {
      if(!last) return;
      downloadFile("prediccion_rhetoric.csv", toCSV(last.sentences), "text/csv");
    });
    $("btnTheme").addEventListener("click", toggleTheme);

    $("btnNewAnalysis").addEventListener("click", () => {
      // Permite editar / pegar un nuevo texto y reinicia salidas
      showEditMode();
      $("out").innerHTML = "";
      $("kpis").innerHTML = "";
      $("filters").style.display = "none";
      $("segmentsCard").style.display = "none";      
      $("resultsFooter").style.display = "none";
      $("sentCountFooter").textContent = "‚Äî";
      $("btnExportJSON").disabled = true;
      $("btnExportCSV").disabled = true;
      $("btnExample").disabled = false;
      setToast("", "Nuevo an√°lisis", "Edite o pegue un nuevo texto y presione ‚ÄúCategorizar‚Äù.");
      $("inputText").focus();
    });

    $("inputText").addEventListener("input", updateCharCount);
    ["filterLabel","sortMode","search"].forEach(id => {
      $(id).addEventListener("input", () => { if(last) renderTable(last); });
      $(id).addEventListener("change", () => { if(last) renderTable(last); });
    });

    (function init(){
      const saved = localStorage.getItem("maia_pubmed_microproyecto1_theme") || "dark";
      applyTheme(saved);
      updateCharCount();
      showEditMode();
      $("resultsFooter").style.display = "none";
      refreshHealth();
      setInterval(refreshHealth, 6000);

      // Demo guiado: si el campo est√° vac√≠o,
      // cargamos un ejemplo rico y ejecutamos una predicci√≥n autom√°tica.
      const t0 = $("inputText");
      const isEmpty = !(((t0 && t0.value) ? t0.value : "").trim());
      if(isEmpty){
        //loadExample();
        // Dispara la clasificaci√≥n una vez para mostrar el potencial de la soluci√≥n.
        //setTimeout(() => { try { predict(); } catch(_) {} }, 300);
      }
    })();
  </script>
</body>
</html>
